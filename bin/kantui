#!/usr/bin/env php
<?php

use Kantui\App;
use Kantui\Support\Context;

use function Laravel\Prompts\clear;

require file_exists(__DIR__ . '/../../../autoload.php') ? __DIR__ . '/../../../autoload.php' : __DIR__ . '/../vendor/autoload.php';

set_error_handler(function ($severity, $message, $file, $line) {
    if ($severity != E_WARNING) {
        return;
    }

    // force all warnings to be exceptions
    throw new RuntimeException($message . ' in ' . $file . ' at line: ' . $line);
});

const KANTUI_VERSION = '0.6.3';

try {
    $context = new Context(getenv('KANTUI_CONTEXT') ?: 'default');

    $context->ensureDefaultFiles();

    $app = new App($context, KANTUI_VERSION);
    clear();
    exit($app->run());
} catch (Throwable $e) {
    // Ensure terminal is cleaned up before showing error
    App::cleanupTerminal();

    if (filter_var(getenv('KANTUI_DEBUG'), FILTER_VALIDATE_BOOLEAN)) {
        throw $e;
    } else {
        fwrite(STDERR, "\033[31mERROR:\033[0m " . $e->getMessage() . PHP_EOL);
        exit(1);
    }
}
